name: 编译全版本 magiskboot for Windows
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安装编译环境
        run: |
          sudo apt update
          sudo apt install -y git build-essential mingw-w64 libz-mingw64-dev

      - name: 编译 6 个版本 magiskboot.exe
        run: |
          mkdir -p output
          cd output

          build() {
              local NAME="$1"
              local REPO="$2"
              local OUT="$3"

              git clone --depth 1 "$REPO" src
              cd src

              # 统一进入 magiskboot 源码目录（兼容所有仓库）
              cd native/src/magiskboot 2>/dev/null || cd src/magiskboot 2>/dev/null || true

              # 编译 Windows 64位 静态 exe
              x86_64-w64-mingw32-g++ -O2 -std=c++17 *.c *.cpp -o "$OUT" -lz -static

              cp "$OUT" ../../../output/
              cd ../../..
              rm -rf src
          }

          build 官方     https://github.com/topjohnwu/Magisk                magiskboot_stable.exe
          build Alpha   https://github.com/HuskyDG/Magisk-alpha           magiskboot_alpha.exe
          build Kitsune https://github.com/Dr-TSON/Kitsune-Mask         magiskboot_kitsune.exe
          build Folk    https://github.com/FolkPatch/FolkPatch        magiskboot_folk.exe
          build SKRoot  https://github.com/secant001/SK-Root             magiskboot_sk.exe
          build APatch  https://github.com/bmax121/APatch               magiskboot_apatch.exe

      - name: 上传编译好的exe
        uses: actions/upload-artifact@v4
        with:
          name: magiskboot_all
          path: output/*.exe
              cd ../../..
              rm -rf src
          }

          # 开始编译 6 个版本
          build 官方 https://github.com/topjohnwu/Magisk                magiskboot_stable.exe
          build Alpha https://github.com/HuskyDG/Magisk-alpha           magiskboot_alpha.exe
          build Kitsune https://github.com/Dr-TSON/Kitsune-Mask         magiskboot_kitsune.exe
          build FolkPatch https://github.com/FolkPatch/FolkPatch        magiskboot_folk.exe
          build SKRoot https://github.com/secant001/SK-Root             magiskboot_sk.exe
          build APatch https://github.com/bmax121/APatch               magiskboot_apatch.exe

      - name: 打包全部exe
        uses: actions/upload-artifact@v4
        with:
          name: magiskboot_all
          path: ./*.exe
              cd ../../..
              rm -rf src
          }

          # 开始编译 6 个版本
          build 官方 https://github.com/topjohnwu/Magisk                magiskboot_stable.exe
          build Alpha https://github.com/HuskyDG/Magisk-alpha           magiskboot_alpha.exe
          build Kitsune https://github.com/Dr-TSON/Kitsune-Mask         magiskboot_kitsune.exe
          build FolkPatch https://github.com/FolkPatch/FolkPatch        magiskboot_folk.exe
          build SKRoot https://github.com/secant001/SK-Root             magiskboot_sk.exe
          build APatch https://github.com/bmax121/APatch               magiskboot_apatch.exe

      - name: 打包全部exe
        uses: actions/upload-artifact@v4
        with:
          name: magiskboot_all
          path: ./*.exe
          mv magiskboot.exe magiskboot_folk.exe
          rm -f magiskboot_folk.zip

          # 5. SK-Root (secant001, v26.1)
          wget -O magiskboot_sk.zip https://github.com/secant001/SK-Root/releases/download/v26.1/magiskboot-x86_64-w64-mingw32.zip
          unzip -q magiskboot_sk.zip
          mv magiskboot.exe magiskboot_sk.exe
          rm -f magiskboot_sk.zip

          # 6. APatch (bmax121, v1.0.0)
          wget -O magiskboot_apatch.zip https://github.com/bmax121/APatch/releases/download/v1.0.0/magiskboot-x86_64-w64-mingw32.zip
          unzip -q magiskboot_apatch.zip
          mv magiskboot.exe magiskboot_apatch.exe
          rm -f magiskboot_apatch.zip

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: magiskboot_all
          path: ./*.exe
